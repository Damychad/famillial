<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Famille</title>
  <link rel="stylesheet" href="family.css">
</head>
<body>
  <header class="topbar hero">
    <div class="hero-overlay"></div>
    <div class="hero-inner">
      <h1 id="site-title">Famille</h1>
      <div id="user-area"></div>
    </div>
  </header>

  <main class="container">
    <section id="login-section" class="card center-card">
      <h2>Sign in</h2>
      <input id="login-user" placeholder="Username" autocomplete="username">
      <input id="login-pass" placeholder="Password" type="password" autocomplete="current-password">
      <div class="row">
        <button id="btn-login">Sign in</button>
        <button id="btn-guest">Continue as Guest</button>
      </div>
      <p id="login-msg" class="muted"></p>
    </section>

    <section id="board-section" class="hidden">
      <div class="row head">
        <h2>Main Board</h2>
        <div>
          <button id="btn-new-post">New Post</button>
          <button id="btn-new-poll">New Poll</button>
        </div>
      </div>
      <div id="posts"></div>
    </section>

    <section id="room-section" class="hidden card room-card">
      <div class="room-inner">
        <h2 id="room-title">My Room</h2>
        <div id="messages"></div>
        <textarea id="msg-input" placeholder="Write a private message (admin can send to others)"></textarea>

        <div class="row">
          <select id="msg-recipient" class="hidden"></select>
          <input type="file" id="msg-image" accept="image/*" class="file-input">
          <button id="btn-send-msg">Send</button>
        </div>
        <div id="msg-preview" class="img-preview hidden"></div>
      </div>
    </section>
  </main>

  <!-- Templates -->
  <template id="post-template">
    <article class="card post">
      <div class="post-head">
        <div class="post-left">
          <img class="post-avatar" alt="author avatar">
          <div>
            <strong class="post-title"></strong>
            <div class="post-meta"></div>
          </div>
        </div>
        <div class="post-right">
          <button class="btn-comment">Comment</button>
          <button class="btn-view-poll hidden">Vote / Results</button>
        </div>
      </div>
      <div class="post-body"></div>
      <div class="post-image-wrap hidden"></div>
      <div class="comments hidden"></div>
    </article>
  </template>

  <template id="poll-template">
    <div class="poll card">
      <div class="poll-options"></div>
      <div class="poll-results hidden"></div>
    </div>
  </template>

  <dialog id="profile-dialog" class="dialog">
    <form method="dialog" class="dialog-inner">
      <h3>Edit profile</h3>
      <div class="row">
        <label class="file-label">Upload avatar<input id="avatar-input" type="file" accept="image/*" class="file-input"></label>
        <div id="avatar-preview" class="img-preview"></div>
      </div>
      <menu>
        <button id="profile-close">Close</button>
      </menu>
    </form>
  </dialog>

  <script>
const API_BASE = 'https://famille-server-production.up.railway.app/api';

const ACCOUNTS = [
  { username: 'Damien', password: 'Admin13072005', role: 'admin', color: '#1a73e8' }, // blue
  { username: 'Sami', password: 'Sami07112009', role: 'user', color: '#e53935' },     // red
  { username: 'Aymane', password: 'Sprigganlord65.', role: 'user', color: '#00bcd4' },// cyan
  { username: 'Errassime', password: 'papa19021972', role: 'user', color: '#2e7d32' }, // green
  { username: 'Saadia', password: 'mama29041967', role: 'user', color: '#8e24aa' },   // purple
  { username: 'Rayan', password: 'sprigganlord65', role: 'user', color: '#616161' }   // grey
];

const STORAGE_KEY = 'famille_app_v1';

function loadState(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch(e){ return {}; }
}
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

let state = loadState();
state.users = state.users || ACCOUNTS.map(a=>({ username:a.username, role:a.role, color:a.color, avatar:null }));
saveState(state);

let currentUser = null;

const el = id => document.getElementById(id);
const uid = () => 'id'+Math.random().toString(36).slice(2,9);
const fmtDate = d => new Date(d).toLocaleString();

const loginSection = el('login-section');
const boardSection = el('board-section');
const roomSection = el('room-section');
const userArea = el('user-area');
const postsEl = el('posts');
const messagesEl = el('messages');
const msgRecipient = el('msg-recipient');
const avatarDialog = el('profile-dialog');

const postTpl = document.getElementById('post-template');
const pollTpl = document.getElementById('poll-template');

/* Fetch helpers */
async function fetchPostsFromServer() {
  const res = await fetch(`${API_BASE}/posts`);
  if (!res.ok) return [];
  return await res.json();
}
async function fetchMessagesFromServer() {
  const res = await fetch(`${API_BASE}/messages`);
  if (!res.ok) return [];
  return await res.json();
}
async function postToServer(formData) {
  const res = await fetch(`${API_BASE}/posts`, { method: 'POST', body: formData });
  return await res.json();
}
async function messageToServer(formData) {
  const res = await fetch(`${API_BASE}/messages`, { method: 'POST', body: formData });
  return await res.json();
}

/* Auth */
function showMessage(txt, elId='login-msg'){ el(elId).textContent = txt; setTimeout(()=>{ if(el(elId).textContent===txt) el(elId).textContent=''; },3000); }

el('btn-login').addEventListener('click', () => {
  const u = el('login-user').value.trim();
  const p = el('login-pass').value;
  if(!u||!p) return showMessage('Enter username and password');
  const acc = ACCOUNTS.find(a => a.username === u && a.password === p);
  if(!acc) return showMessage('Invalid credentials');
  currentUser = { username: acc.username, role: acc.role, color: acc.color };
  onLogin();
});

el('btn-guest').addEventListener('click', () => {
  currentUser = { username: 'Guest', role: 'guest', color:'#333' };
  onLogin();
});

async function onLogin(){
  loginSection.classList.add('hidden');
  boardSection.classList.remove('hidden');
  roomSection.classList.remove('hidden');
  document.body.classList.add('room-active');
  renderUserArea();
  // LOAD posts/messages from server!
  state.posts = await fetchPostsFromServer();
  state.messages = await fetchMessagesFromServer();
  renderPosts();
  renderMessages();
  renderRecipientOptions();
  document.getElementById('btn-new-post').style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
  document.getElementById('btn-new-poll').style.display = currentUser.role === 'admin' ? 'inline-block' : 'none';
}

/* User area */
function renderUserArea(){
  userArea.innerHTML = '';
  const userWrap = document.createElement('div'); userWrap.className='user-wrap';
  const dot = document.createElement('img');
  dot.className = 'user-dot avatar-small';
  const urec = state.users.find(u=>u.username===currentUser.username);
  if(urec && urec.avatar) dot.src = urec.avatar;
  else dot.src = '';

  const name = document.createElement('span');
  name.textContent = currentUser.username + (currentUser.role === 'admin' ? ' (admin)' : '');
  const out = document.createElement('button');
  out.textContent = 'Logout';
  out.onclick = () => {
    currentUser = null;
    loginSection.classList.remove('hidden');
    boardSection.classList.add('hidden');
    roomSection.classList.add('hidden');
    userArea.innerHTML='';
    document.body.classList.remove('room-active');
  };

  const edit = document.createElement('button');
  edit.textContent = 'Edit profile';
  edit.onclick = () => openProfileDialog();

  userWrap.appendChild(dot); userWrap.appendChild(name); userWrap.appendChild(edit); userWrap.appendChild(out);
  userArea.appendChild(userWrap);
}

/* Profile dialog (unchanged, still uses local storage for avatars) */
function openProfileDialog(){
  const avatarInput = el('avatar-input');
  const preview = el('avatar-preview');
  const urec = state.users.find(u=>u.username===currentUser.username);
  preview.innerHTML = '';
  if(urec && urec.avatar){
    const img = document.createElement('img'); img.src = urec.avatar; img.className='img-preview-inner'; preview.appendChild(img);
  }
  avatarInput.onchange = (e) => {
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const data = reader.result;
      preview.innerHTML = `<img src="${data}" class="img-preview-inner">`;
      urec.avatar = data;
      const uidx = state.users.findIndex(x=>x.username===urec.username);
      if(uidx>-1) state.users[uidx] = urec;
      saveState(state);
      renderUserArea();
      renderPosts();
    };
    reader.readAsDataURL(f);
  };
  avatarDialog.showModal();
  el('profile-close').onclick = () => avatarDialog.close();
}

/* Posts */
function renderPosts(){
  postsEl.innerHTML = '';
  const sorted = (state.posts || []).slice().sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  sorted.forEach(p => {
    const node = postTpl.content.cloneNode(true);
    node.querySelector('.post-title').textContent = p.title;
    node.querySelector('.post-meta').textContent = `${p.author} • ${fmtDate(p.createdAt)}`;
    node.querySelector('.post-body').textContent = p.body || '';

    const avatarEl = node.querySelector('.post-avatar');
    const urec = state.users.find(u=>u.username===p.author);
    if(urec && urec.avatar) { avatarEl.src = urec.avatar; } else { avatarEl.src = ''; avatarEl.alt = p.author[0] || 'U'; }

    const imgWrap = node.querySelector('.post-image-wrap');
    if(p.image){
      imgWrap.classList.remove('hidden');
      imgWrap.innerHTML = `<img src="${p.image}" alt="post image" class="post-image">`;
    } else imgWrap.classList.add('hidden');

    const postEl = node.querySelector('article');
    const commentsWrap = postEl.querySelector('.comments');
    if(p.comments && p.comments.length){
      commentsWrap.classList.remove('hidden');
      commentsWrap.innerHTML = '';
      p.comments.forEach(c => {
        const cdiv = document.createElement('div'); cdiv.className='comment';
        cdiv.innerHTML = `<strong style="color:${getUserColor(c.user)}">${c.user}</strong> <span class="meta">${fmtDate(c.date)}</span><div>${escapeHtml(c.text)}</div>`;
        commentsWrap.appendChild(cdiv);
      });
    } else commentsWrap.classList.add('hidden');

    const btnComment = postEl.querySelector('.btn-comment');
    btnComment.onclick = async () => {
      const txt = prompt('Comment text');
      if(!txt) return;
      // Add to local copy and just re-render (not saved server-side since backend doesn't support comments yet)
      p.comments = p.comments || [];
      p.comments.push({ user: currentUser.username, text: txt, date: new Date().toISOString() });
      renderPosts();
    };

    const btnPoll = postEl.querySelector('.btn-view-poll');
    if(p.kind === 'poll'){
      btnPoll.classList.remove('hidden');
      btnPoll.onclick = () => showPollDialog(p);
    } else btnPoll.classList.add('hidden');

    postsEl.appendChild(node);
  });
}

/* Poll UI (unchanged) */
function showPollDialog(p){
  const dlg = document.createElement('div');
  dlg.className='dialog';
  const pollNode = pollTpl.content.cloneNode(true);
  const optWrap = pollNode.querySelector('.poll-options');
  const resWrap = pollNode.querySelector('.poll-results');
  p.options.forEach(opt => {
    const id = opt.id;
    const btn = document.createElement('button');
    btn.textContent = opt.label;
    btn.onclick = () => {
      p.votes = p.votes || {};
      Object.keys(p.votes).forEach(k => { p.votes[k] = (p.votes[k]||[]).filter(u=>u!==currentUser.username); });
      p.votes[id] = p.votes[id] || [];
      if(!p.votes[id].includes(currentUser.username)) p.votes[id].push(currentUser.username);
      renderPosts();
      showResults();
    };
    optWrap.appendChild(btn);
  });
  function showResults(){
    resWrap.classList.remove('hidden');
    resWrap.innerHTML = '';
    const totals = {};
    (p.options||[]).forEach(o=> totals[o.id]= (p.votes && p.votes[o.id]) ? p.votes[o.id].length : 0);
    const sum = Object.values(totals).reduce((a,b)=>a+b,0) || 0;
    (p.options||[]).forEach(o=>{
      const row = document.createElement('div');
      const count = totals[o.id];
      const pct = sum ? Math.round(count/sum*100) : 0;
      row.innerHTML = `<strong>${o.label}</strong> — ${count} votes (${pct}%)`;
      resWrap.appendChild(row);
    });
  }
  showResults();
  dlg.appendChild(pollNode);
  const close = document.createElement('button'); close.textContent='Close'; close.onclick=()=>dlg.remove();
  dlg.appendChild(close);
  document.body.appendChild(dlg);
}

/* Messages */
function renderMessages(){
  messagesEl.innerHTML = '';
  const mine = (state.messages||[]).filter(m => m.recipient === currentUser.username || m.sender === currentUser.username)
                            .sort((a,b)=> new Date(b.date)-new Date(a.date));
  if(mine.length===0) messagesEl.textContent = 'No messages';
  else {
    mine.forEach(m=>{
      const card = document.createElement('div'); card.className='card msg';
      let imgHtml = '';
      if(m.image) imgHtml = `<div class="message-image-wrap"><img src="${m.image}" class="message-image"></div>`;
      card.innerHTML = `<div class="meta"><strong style="color:${getUserColor(m.sender)}">${m.sender}</strong> → <strong style="color:${getUserColor(m.recipient)}">${m.recipient}</strong> <span class="small">${fmtDate(m.date)}</span></div><div>${escapeHtml(m.body)}</div>${imgHtml}`;
      messagesEl.appendChild(card);
    });
  }
}

/* Send message with optional image */
el('btn-send-msg').addEventListener('click', async () => {
  const body = el('msg-input').value.trim();
  const fileInput = el('msg-image');
  const file = fileInput.files && fileInput.files[0];
  if(!body && !file) return;
  let recipient = currentUser.username;
  if(currentUser.role==='admin') recipient = msgRecipient.value || currentUser.username;

  const formData = new FormData();
  formData.append('sender', currentUser.username);
  formData.append('recipient', recipient);
  formData.append('body', body);
  if(file) formData.append('image', file);

  await messageToServer(formData); // Save to server
  state.messages = await fetchMessagesFromServer(); // Re-load
  el('msg-input').value=''; fileInput.value=''; el('msg-preview').classList.add('hidden');
  renderMessages();
});

/* New post / poll (now posts to server!) */
el('btn-new-post').addEventListener('click', async () => {
  if(currentUser.role !== 'admin') return alert('Only admin can post news.');
  const title = prompt('Post title');
  if(!title) return;
  const body = prompt('Post body (optional)');
  const attach = confirm('Attach an image to this post? (select OK to choose file)');
  const formData = new FormData();
  formData.append('title', title);
  formData.append('body', body || '');
  formData.append('author', currentUser.username);
  if(attach){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = async (e) => {
      const f = e.target.files[0]; if(!f) return;
      formData.append('image', f);
      await postToServer(formData); // Save to server
      state.posts = await fetchPostsFromServer(); // Re-load
      renderPosts();
    };
    inp.click();
  } else {
    await postToServer(formData);
    state.posts = await fetchPostsFromServer();
    renderPosts();
  }
});

el('btn-new-poll').addEventListener('click', async () => {
  if(currentUser.role !== 'admin') return alert('Only admin can create polls.');
  const title = prompt('Poll title');
  if(!title) return;
  const raw = prompt('Enter options separated by | (e.g. Yes|No|Maybe)');
  if(!raw) return;
  const parts = raw.split('|').map(s=>s.trim()).filter(Boolean);
  const options = parts.map(p=>({ id: uid(), label: p }));
  // Save as a post with kind: 'poll'
  const formData = new FormData();
  formData.append('title', title);
  formData.append('body', '');
  formData.append('author', currentUser.username);
  // Backend does not support options/votes yet, so store it only locally for now
  const post = { id: uid(), title, body: '', author: currentUser.username, kind: 'poll', options, votes: {}, createdAt: new Date().toISOString(), comments: [] };
  state.posts.push(post);
  renderPosts();
});

/* Utilities */
function getUserColor(username){
  const u = state.users.find(x=>x.username===username);
  return u ? u.color : '#333';
}
function renderRecipientOptions(){
  msgRecipient.innerHTML = '';
  state.users.forEach(u=>{
    const opt = document.createElement('option'); opt.value = u.username; opt.textContent = u.username;
    msgRecipient.appendChild(opt);
  });
  msgRecipient.classList.toggle('hidden', currentUser.role!=='admin');
}

/* Message image preview */
el('msg-image').addEventListener('change', (e)=>{
  const f = e.target.files[0]; const p = el('msg-preview');
  if(!f){ p.classList.add('hidden'); return; }
  const r = new FileReader(); r.onload=()=>{ p.innerHTML = `<img src="${r.result}" class="img-preview-inner">`; p.classList.remove('hidden'); }; r.readAsDataURL(f);
});

/* Helpers */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }
</script>
</body>
</html>
